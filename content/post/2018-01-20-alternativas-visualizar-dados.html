---
title: Gráficos alternativos para grandes conjuntos de dados
author: Melina de Souza Leite
date: '2018-01-20'
categories:
  - R
tags:
  - plot
  - visualização_dados
slug: alternativas-visualizar-dados
language:
  label:
    fig: 'Figura '
    tab: 'Tabela '
---



<p>Recentemente, ao tentar fazer gráficos exploratórios de um grande conjunto de dados (~300 mil observações), fiz uma rápida busca na internet e achei alternativas interessantes aos histogramas de frequência e densidade e também aos famosos boxplots. Abaixo, apresento exemplos do que encontrei.</p>
<p>Lembrando que o material deste roteiro (arquivo .Rmd) está disponível <a href="https://github.com/melina-leite/roteiro_plots_bigdata">neste repositório do GitHub</a>.</p>
<p>Nesse roteiro, todos os gráficos utilizarão como base o pacote <code>ggplot2</code>, e algumas manipulações dos dados com o pacote <code>dplyr</code>. Ah, e eu também uso o pacote <code>cowplot</code>para tornar os plots do ggplot estéticamente melhores.</p>
<pre class="r"><code>library(ggplot2)
library(dplyr)
library(cowplot)
library(lvplot)</code></pre>
<p>Usarei o conjunto de dados <code>ontime</code> do pacote <code>lvplot</code>, que detalha o desempenho no horário dos vôos nacionais dos EUA em janeiro de 2015, veja uma amostra dos dados na Tabela <a href="#tab:dados">1</a>.</p>
<table>
<caption><span id="tab:dados">Table 1: </span>Algumas linhas da tabela de dados.</caption>
<thead>
<tr class="header">
<th align="left">FlightDate</th>
<th align="left">UniqueCarrier</th>
<th align="right">FlightNum</th>
<th align="left">DepTime</th>
<th align="left">ArrTime</th>
<th align="right">TaxiOut</th>
<th align="right">TaxiIn</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">2015-01-01</td>
<td align="left">AA</td>
<td align="right">1</td>
<td align="left">0855</td>
<td align="left">1237</td>
<td align="right">17</td>
<td align="right">7</td>
</tr>
<tr class="even">
<td align="left">2015-01-02</td>
<td align="left">AA</td>
<td align="right">1</td>
<td align="left">0850</td>
<td align="left">1211</td>
<td align="right">15</td>
<td align="right">9</td>
</tr>
<tr class="odd">
<td align="left">2015-01-03</td>
<td align="left">AA</td>
<td align="right">1</td>
<td align="left">0853</td>
<td align="left">1151</td>
<td align="right">15</td>
<td align="right">13</td>
</tr>
<tr class="even">
<td align="left">2015-01-04</td>
<td align="left">AA</td>
<td align="right">1</td>
<td align="left">0853</td>
<td align="left">1218</td>
<td align="right">14</td>
<td align="right">19</td>
</tr>
<tr class="odd">
<td align="left">2015-01-05</td>
<td align="left">AA</td>
<td align="right">1</td>
<td align="left">0853</td>
<td align="left">1222</td>
<td align="right">27</td>
<td align="right">24</td>
</tr>
<tr class="even">
<td align="left">2015-01-06</td>
<td align="left">AA</td>
<td align="right">1</td>
<td align="left">0856</td>
<td align="left">1300</td>
<td align="right">85</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="left">2015-01-07</td>
<td align="left">AA</td>
<td align="right">1</td>
<td align="left">0859</td>
<td align="left">1221</td>
<td align="right">29</td>
<td align="right">12</td>
</tr>
<tr class="even">
<td align="left">2015-01-08</td>
<td align="left">AA</td>
<td align="right">1</td>
<td align="left">0856</td>
<td align="left">1158</td>
<td align="right">26</td>
<td align="right">3</td>
</tr>
<tr class="odd">
<td align="left">2015-01-09</td>
<td align="left">AA</td>
<td align="right">1</td>
<td align="left">0901</td>
<td align="left">1241</td>
<td align="right">43</td>
<td align="right">4</td>
</tr>
<tr class="even">
<td align="left">2015-01-10</td>
<td align="left">AA</td>
<td align="right">1</td>
<td align="left">0903</td>
<td align="left">1235</td>
<td align="right">37</td>
<td align="right">10</td>
</tr>
</tbody>
</table>
<p>Comecemos com os histogramas!</p>
<div id="histogramas" class="section level1">
<h1>Histogramas</h1>
<p>O primeiro gráfico para comparar a distribuição de variáveis contínuas é o histograma de frequência ou densidade. Muitas vezes o que queremos fazer é comparar os histogramas em função de algum variável categórica, como no exemplo abaixo, onde criamos os histogramas da variável <code>TaxiOut</code><a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a> em funcão das companhias aéreas (<code>UniqueCarrier</code>).</p>
<pre class="r"><code>hi &lt;- ggplot(ontime, aes(x = TaxiOut, fill = UniqueCarrier)) + 
  facet_wrap(~UniqueCarrier, scales = &quot;free&quot;) + #deixei as escalas livres
  scale_x_log10() +
  theme(legend.position = &quot;none&quot;)
hi + geom_histogram()</code></pre>
<p><img src="/post/2018-01-20-alternativas-visualizar-dados_files/figure-html/unnamed-chunk-2-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>hi + geom_density()</code></pre>
<p><img src="/post/2018-01-20-alternativas-visualizar-dados_files/figure-html/unnamed-chunk-2-2.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="alternativa-1-ridgeline-plots" class="section level1">
<h1>Alternativa 1: Ridgeline plots</h1>
<p>Uma alternativa ao histograma de densidade são os ridgeline plots do pacote <code>ggridges</code> que são gráficos parcialmente sobrepostos criando a impressão de uma cadeia de montanhas. São gráficos particularmente bons para visualizar as mudanças na distribuiçào no tempo e espaço.</p>
<p>Neste exemplo, vou ordenar as companhias aéreas por sua mediana.</p>
<pre class="r"><code>library(ggridges)

rplot &lt;- ontime %&gt;%
  mutate(group = reorder(UniqueCarrier, TaxiOut, median)) %&gt;%
  ggplot(aes(x = TaxiOut, y = UniqueCarrier, fill=UniqueCarrier)) + 
  scale_x_log10(limits=c(5,50), breaks= c(5,10,25,50)) +
  theme(legend.position = &quot;none&quot;)

rplot +  geom_density_ridges()</code></pre>
<p><img src="/post/2018-01-20-alternativas-visualizar-dados_files/figure-html/unnamed-chunk-3-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>A altura de cada densidade pode ser ajustada para haver menos sobreposição:</p>
<pre class="r"><code>rplot + geom_density_ridges(scale=1)</code></pre>
<p><img src="/post/2018-01-20-alternativas-visualizar-dados_files/figure-html/unnamed-chunk-4-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="alternativa-2-violin-plots" class="section level1">
<h1>Alternativa 2: violin plots</h1>
<p>Outra alternativa, mais parecida com boxplots (tratados a seguir) é o violin plot (do próprio pacote do <code>ggplot2</code>).</p>
<pre class="r"><code>vio &lt;- ontime %&gt;% mutate(group = reorder(UniqueCarrier, TaxiOut, median)) %&gt;%
  ggplot(aes(y = TaxiOut, x = UniqueCarrier, fill = UniqueCarrier)) +
  scale_y_log10() +
  theme(legend.position = &quot;none&quot;)
vio + geom_violin()</code></pre>
<p><img src="/post/2018-01-20-alternativas-visualizar-dados_files/figure-html/unnamed-chunk-5-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Uma possibilidade é colocar boxplots (sem valores extremos para não poluir a figura) dentro do violin plot para facilitar encontrar a mediana e quartis:</p>
<pre class="r"><code>vio + geom_violin() + geom_boxplot(width=0.4, outlier.alpha = 0)</code></pre>
<p><img src="/post/2018-01-20-alternativas-visualizar-dados_files/figure-html/unnamed-chunk-6-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="boxplots" class="section level1">
<h1>Boxplots</h1>
<p>Os boxplots deixam de ser úteis quando o volume de dados aumenta (Hofmann et al. 2017), pois o que eles consideram valores extremos (outliers) aumenta linearmente com o tamanho amostral. E é por isso que no violinplot nós removemos os outliers do gráfico. Ainda sim é um dos gráficos mais utilizados para se observar distribiução dos dados (veja <a href="http://had.co.nz/stat645/project-03/boxplots.pdf">aqui</a> sobre 40 anos de história do boxplot).</p>
<pre class="r"><code>ontime %&gt;% mutate(group = reorder(UniqueCarrier, TaxiOut, median)) %&gt;%
  ggplot(aes(y = TaxiOut, x = UniqueCarrier, fill = UniqueCarrier)) +
  scale_y_log10() +
  theme(legend.position = &quot;none&quot;) +
  geom_boxplot()</code></pre>
<p><img src="/post/2018-01-20-alternativas-visualizar-dados_files/figure-html/unnamed-chunk-7-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="alternativa-3-letter-value-plot" class="section level1">
<h1>Alternativa 3: letter-value plot</h1>
<p>Uma recém criada alternativa aos boxplots convencionais, são os <em>letter-value plots</em> (veja Hofmann et al. 2017), que estão disponíveis no pacote <code>lvplot</code>. Este plot é baseado na estimativa de quantis (outros que não o primeiro e terceiro como no boxplot). Entretanto, as estimativas somente são confiáveis se há bastante dados!</p>
<p>Abaixo alguns exemplos de uso dos lv-plots, com diferentes opções para a largura dos plots:</p>
<ol style="list-style-type: decimal">
<li><p><code>linear</code>: torna a largura de cada xaixa inversamente proporcional ao quantil (letter-value) que ele representa, ou seja, começando com os quartis, cada caixa subsequente será um passo mais fina do que a anterior.</p></li>
<li><p><code>area</code>: torna a área de cada caixa proporcional ao número de observações nela.</p></li>
<li><p><code>height</code>: torna a largura de cada caixa proporcional ao número de pontos nela.</p></li>
</ol>
<pre class="r"><code>library(lvplot)
library(patchwork) # para fazer painel com vários plots
lv &lt;- ontime %&gt;% mutate(group = reorder(UniqueCarrier, TaxiOut, median)) %&gt;%
  ggplot(aes(y = TaxiOut, x = UniqueCarrier)) +
  scale_y_log10() +
  theme(legend.position = &quot;none&quot;)

lv + geom_lv(aes(fill=..LV..), width.method = &quot;height&quot;) +
  scale_fill_lv() + ggtitle(&quot;Largura do plot `height`&quot;)</code></pre>
<p><img src="/post/2018-01-20-alternativas-visualizar-dados_files/figure-html/unnamed-chunk-8-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>lv + geom_lv(aes(fill=..LV..), width.method = &quot;linear&quot;) +
  scale_fill_lv() + ggtitle(&quot;Largura do plot `linear`&quot;)</code></pre>
<p><img src="/post/2018-01-20-alternativas-visualizar-dados_files/figure-html/unnamed-chunk-9-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Eu particularmente acho o gráfico com largura <code>height</code> o mais bonito!</p>
<p>Compare a diferença no número de valores extremos encontrados no boxplot comum e no lvplot!</p>
</div>
<div id="referencias" class="section level1">
<h1>Referências</h1>
<p>Hofmann, H., Wickham, H., Kafadar, K., 2017. Letter-Value Plots: Boxplots for Large Data. Journal of Computational and Graphical Statistics 26, 469–477. <a href="https://doi.org/10.1080/10618600.2017.1305277" class="uri">https://doi.org/10.1080/10618600.2017.1305277</a> <a href="http://vita.had.co.nz/papers/letter-value-plot.html">link alternativo</a></p>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>O tempo de Taxi-out é definido como o tempo gasto por um vôo entre o tempo de desligamento real (AOBT) e o tempo de descolagem real (ATOT). Variável numérica do tempo de táxi em minutos.<a href="#fnref1">↩</a></p></li>
</ol>
</div>
